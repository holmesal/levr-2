{% extends "templates/merchants-mobile-base.html" %}

{% block htmlhead %}{% endblock %}



{% block content %}
Start typing the name of your business, then select it from the list below.
<input type="text" id="business" placeholder="Your business name" value="{{query}}">
<div id="loading" hidden>
	Loading...
</div>
<div id="results"></div>
{% endblock %}



{% block javascript %}
<script type="text/javascript">

	var delay = (function(){
	  var timer = 0;
	  return function(callback, ms){
	    clearTimeout (timer);
	    timer = setTimeout(callback, ms);
	  };
	})();
	
	
	
	populateAutocomplete = function(response){
		//hide the loading bit
		$('#loading').hide()
		
		//clear out the list
		$('#results').empty()
		
		//add in the new results
		for (var i=0,len=response.length; i<len; i++){
			pre = response[i]
			name = pre.terms[0].value
			vicinity = pre.description.substr(pre.terms[1].offset)
			html = '<div class="result" id='+pre.reference+'><p class="name">'+name+'</p><p class="vicinity">'+vicinity+'</p></div>'
			$('#results').append(html)
		}
		
		//re-register the listeners
		$('.result').on('click',function(e){
			window.location = '/merchants/mobile/businessdetails?reference='+e.currentTarget.id+'&query='+$('#business').val()
		})
	}
	
	
	queryGooglePlaces = function(query){
		
		
		//kill any previous requests, if they exist
		if(typeof request!='undefined'){
		   request.abort()
		   console.log('Running request killed')
		} else{
			console.log('No request')
		}
		
		
		//make the request
		url = '/merchants/mobile/autocomplete?query='+escape(query)
		request = $.getJSON(url,function(data){populateAutocomplete(data)})
	}
	
	$("#business").keyup(function(){
		if ($('#business').val().length>2){
			//show the loading bit
			$('#loading').show()
			delay(function(){
		      queryGooglePlaces($('#business').val())
		    }, 500 );
		} else{
			//clear out the autocomplete
			$('#results').empty()
		}
	})
	
	//If jinja2 is writing out a value to the input, do the search
	if ($('#business').val().length != 0){
		//show the loading bit
		$('#loading').show()
		queryGooglePlaces($('#business').val())
	}
	
</script>
{% endblock %}